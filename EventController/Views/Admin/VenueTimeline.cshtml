@model List<Event>
@{
    ViewData["Title"] = "Venue Timeline";
    var venue = ViewBag.Venue as Venue;
    var currentEvent = ViewBag.CurrentEvent as Event;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Venue Timeline - @venue?.Name</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
    <style>
        .timeline {
            position: relative;
            padding: 20px 0;
        }
        .timeline-item {
            position: relative;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 3px solid #dee2e6;
        }
        .timeline-item.current-event {
            border-left-color: #ffc107;
            background-color: #fff3cd;
        }
        .timeline-item.active-event {
            border-left-color: #28a745;
            background-color: #d4edda;
        }
        .timeline-item.upcoming-event {
            border-left-color: #007bff;
            background-color: #d1ecf1;
        }
        .timeline-item.conflict {
            border-left-color: #dc3545;
            background-color: #f8d7da;
        }
        .event-time {
            font-weight: bold;
            color: #495057;
        }
        .conflict-warning {
            background-color: #f8d7da;
            border: 2px solid #dc3545;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container my-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fw-bold">
                <i class="bi bi-building"></i> @venue?.Name - Event Timeline
            </h2>
            <a asp-action="EventAdmin" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back to Events
            </a>
        </div>

        @if (currentEvent != null)
        {
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-warning">
                    <h5 class="mb-0"><i class="bi bi-calendar-event"></i> Event Requesting Approval</h5>
                </div>
                <div class="card-body">
                    <h4>@currentEvent.Title</h4>
                    <p class="mb-2">
                        <i class="bi bi-clock"></i> 
                        <strong>Start:</strong> @currentEvent.StartTime.ToString("MMMM dd, yyyy hh:mm tt")
                    </p>
                    <p class="mb-2">
                        <i class="bi bi-clock-fill"></i> 
                        <strong>End:</strong> @currentEvent.EndTime.ToString("MMMM dd, yyyy hh:mm tt")
                    </p>
                    <p class="mb-0">
                        <i class="bi bi-hourglass-split"></i> 
                        <strong>Duration:</strong> @((currentEvent.EndTime - currentEvent.StartTime).TotalHours.ToString("0.0")) hours
                    </p>
                </div>
            </div>

            {
                var conflicts = Model.Where(e => e.EventID != currentEvent.EventID 
                    && e.StartTime < currentEvent.EndTime 
                    && e.EndTime > currentEvent.StartTime).ToList();
                
                if (conflicts.Any())
                {
                    <div class="conflict-warning">
                        <h5 class="text-danger mb-3">
                            <i class="bi bi-exclamation-triangle-fill"></i> Schedule Conflict Detected!
                        </h5>
                        <p class="mb-2">The requested event overlaps with the following scheduled event(s):</p>
                        <ul class="mb-0">
                            @foreach (var conflict in conflicts)
                            {
                                <li>
                                    <strong>@conflict.Title</strong> - 
                                    @conflict.StartTime.ToString("MMM dd, hh:mm tt") to @conflict.EndTime.ToString("MMM dd, hh:mm tt")
                                    <span class="badge bg-@(conflict.Status == "Active" ? "success" : "primary")">@conflict.Status</span>
                                </li>
                            }
                        </ul>
                        <div class="mt-3">
                            <strong class="text-danger">
                                <i class="bi bi-x-circle"></i> Cannot approve this event due to scheduling conflicts.
                            </strong>
                        </div>
                    </div>
                }
                else
                {
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle-fill"></i> 
                        <strong>No conflicts found!</strong> This venue is available for the requested time slot.
                    </div>
                }
            }
        }

        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-calendar3"></i> Active & Upcoming Events Schedule
                </h5>
            </div>
            <div class="card-body">
                @if (Model != null && Model.Any())
                {
                    <div class="timeline">
                        @foreach (var evt in Model.OrderBy(e => e.StartTime))
                        {
                            var isCurrent = currentEvent != null && evt.EventID == currentEvent.EventID;
                            var cssClass = isCurrent ? "current-event" : (evt.Status == "Active" ? "active-event" : "upcoming-event");
                            
                            <div class="timeline-item @cssClass">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h5 class="mb-2">
                                            @evt.Title
                                            @if (isCurrent)
                                            {
                                                <span class="badge bg-warning text-dark">Requesting Approval</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-@(evt.Status == "Active" ? "success" : "primary")">@evt.Status</span>
                                            }
                                        </h5>
                                        <p class="mb-1 event-time">
                                            <i class="bi bi-clock"></i> 
                                            @evt.StartTime.ToString("MMM dd, yyyy - hh:mm tt")
                                        </p>
                                        <p class="mb-1 event-time">
                                            <i class="bi bi-clock-fill"></i> 
                                            @evt.EndTime.ToString("MMM dd, yyyy - hh:mm tt")
                                        </p>
                                        <p class="mb-1 text-muted">
                                            <i class="bi bi-tag"></i> @evt.Category?.CategoryName
                                        </p>
                                        <p class="mb-0 text-muted">
                                            <i class="bi bi-person"></i> Organizer: @evt.Organizer?.FullName
                                        </p>
                                    </div>
                                    <div>
                                        <a href="@Url.Action("Index", "Event", new { id = evt.EventID })" 
                                           class="btn btn-sm btn-outline-primary" target="_blank">
                                            <i class="bi bi-eye"></i> View
                                        </a>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-calendar-x fs-1 d-block mb-2"></i>
                        No active or upcoming events scheduled for this venue.
                    </div>
                }
            </div>
        </div>

        <div class="mt-4">
            <a asp-action="EventAdmin" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Event Management
            </a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
